# Phase 4: Exact Code Changes Reference

This document shows exactly what code changes from Phase 3 to Phase 4. Use this as a reference while implementing.

---

## 1. File Deletions

### Delete: `app/styles/create/_critical.template.scss`

**Current Content**:

```scss
// CRITICAL CSS TEMPLATE
// âš ï¸  This file defines the structure and abstracts for critical CSS.
// Component imports are auto-generated from /* @critical */ markers during build.
//
// DO NOT manually edit component importsâ€”add the /* @critical */ marker
// to your component file instead, and the plugin will auto-detect it.
//
// Template changes propagate to all regenerations.

// Abstract tokens (always included for styling foundation)
// These define CSS variables and utility classes available to all components
@use "root";
@use "typography";
@use "flex";
@use "colors";
@use "spacings";
@use "borders";
@use "statuses";
@use "sizes";

// AUTO-GENERATED SECTION BELOW
// Plugin will insert detected critical components here at build time
// Do not manually edit this section
```

**Action**: DELETE

---

### Delete: `app/styles/create/_non-critical.template.scss`

**Current Content**:

```scss
// NON-CRITICAL CSS TEMPLATE
// âš ï¸  This file defines utilities and structure for non-critical (async-loaded) CSS.
// Component imports are auto-generated from /* @non-critical */ markers during build.
//
// DO NOT manually edit component importsâ€”add the /* @non-critical */ marker
// to your component file instead, and the plugin will auto-detect it.
//
// Template changes propagate to all regenerations.

// AUTO-GENERATED SECTION BELOW
// Plugin will insert detected non-critical components here at build time
// Do not manually edit this section
```

**Action**: DELETE

---

## 2. File Modifications

### Modify: `app/styles/create/_index.scss`

**BEFORE (Phase 3)**:

```scss
/**
 * CSS Generation from Design Tokens
 * 
 * Phase 3: Proper CSS Code Splitting
 * 
 * This file imports ONLY critical CSS that will be inlined in <head>.
 * Non-critical CSS is imported separately in app/styles/non-critical-entry.scss
 * 
 * In PRODUCTION BUILD:
 * - This file â†’ root-*.css (critical, inlined in <style> tag)
 * - non-critical-entry.scss â†’ non-critical-*.css (external, lazy-loaded)
 * - css-compiled-separately plugin handles the separate compilation
 * 
 * In DEVELOPMENT MODE:
 * - Both entry points are compiled by Vite's dev server
 * - Vite automatically includes both via optimizeDeps
 * - HMR handles instant updates for both
 * 
 * Result:
 * - Dev: All styles available for rapid development (via dual entry points)
 * - Prod: Optimized split (critical inline, non-critical async)
 * - No CSS duplication in either mode
 */

@use "critical";
```

**AFTER (Phase 4)**:

```scss
/**
 * CSS Utility Class Generators
 * 
 * This file ONLY generates utility classes from design token abstracts.
 * It does NOT include component styles or abstract tokens.
 * 
 * Abstract tokens are auto-imported via:
 * - app/styles/index.scss â†’ imports _generated-critical.scss
 * - app/styles/non-critical-entry.scss â†’ imports _generated-non-critical.scss
 * 
 * This file is imported by both entry points to ensure utility classes
 * are available in both critical and non-critical CSS bundles.
 * 
 * Utility generators:
 * - Borders (from _borders.scss)
 * - Colors (from _colors.scss)
 * - Flex (from _flex.scss)
 * - Sizes (from _sizes.scss)
 * - Spacings (from _spacings.scss)
 * - Statuses (from _statuses.scss)
 * - Typography (from _typography.scss)
 */

@use "borders";
@use "colors";
@use "flex";
@use "sizes";
@use "spacings";
@use "statuses";
@use "typography";
```

**Key Changes**:

- Remove: `@use "critical";` (abstracts are now in .internal/)
- Add: Explicit list of utility imports
- Update: Comment to explain new structure
- Remove: Root CSS variable mentions (abstracts handle this)

---

### Modify: `app/styles/index.scss`

**BEFORE (Phase 3)**:

```scss
@use "create/index" as create;
@forward "abstracts/spacings";
@forward "abstracts/colors";
@forward "abstracts/typography";
@forward "abstracts/mixins";
```

**AFTER (Phase 4)**:

```scss
/**
 * Main CSS Entry Point (Critical CSS Only)
 *
 * This file compiles to: root-*.css (inlined in <head>)
 *
 * What's imported:
 * 1. Abstracts + critical components (auto-generated by plugin)
 * 2. Utility class generators (from design tokens)
 *
 * The plugin auto-generates:
 * - app/.internal/critical-css/_generated-critical.scss
 *   Contains: ALL abstracts + components marked with /* @critical */
 *
 * Non-critical components are loaded separately:
 * - app/styles/non-critical-entry.scss
 */

// Auto-generated critical CSS (all abstracts + critical components)
@use "../.internal/critical-css/generated-critical" as critical;

// Utility class generators
@use "create/index" as create;
```

**Key Changes**:

- Remove: Direct @use and @forward of abstracts
- Add: Import from `.internal/critical-css/generated-critical`
- Add: Clear comments explaining the structure
- Remove: Individual abstract forwards

---

### Modify: `app/styles/non-critical-entry.scss`

**BEFORE (Phase 3)**:

```scss
/**
 * Non-Critical CSS Entry Point (Phase 3)
 * 
 * This is a separate SCSS entry point that compiles ONLY non-critical CSS.
 * During build, Vite will create a separate non-critical-*.css bundle from this file.
 * 
 * In the Vite build:
 * - app/styles/index.scss â†’ root-*.css (critical CSS, inlined in <head>)
 * - app/styles/non-critical-entry.scss â†’ non-critical-*.css (async-loaded)
 * 
 * The beasties-processor will:
 * 1. Inline root-*.css as <style id="critical-css"> tag
 * 2. Add non-critical-*.css as <link rel="stylesheet"> tag with lazy-loading
 */

@use "create/non-critical";
```

**AFTER (Phase 4)**:

```scss
/**
 * Non-Critical CSS Entry Point (Phase 4)
 *
 * This file compiles to: non-critical-*.css (async-loaded via media=print trick)
 *
 * What's imported:
 * 1. Non-critical components (auto-generated by plugin)
 * 2. Utility class generators (from design tokens)
 *
 * The plugin auto-generates:
 * - app/.internal/critical-css/_generated-non-critical.scss
 *   Contains: ALL components NOT marked with /* @critical */
 *
 * Critical components are inlined separately:
 * - app/styles/index.scss (compiled to root-*.css, inlined)
 */

// Auto-generated non-critical components
@use "../.internal/critical-css/generated-non-critical" as noncritical;

// Utility class generators
@use "create/index" as create;
```

**Key Changes**:

- Remove: `@use "create/non-critical";`
- Add: Import from `.internal/critical-css/generated-non-critical`
- Add: Import of `create/index` (utility generators)
- Update: Comments to explain new structure

---

## 3. New Files

### New: `app/.internal/README.md`

```markdown
# âš ï¸ Internal Build System

This directory contains **auto-managed** files generated by the build system during:

- `yarn dev` (development mode)
- `yarn build` (production build)

## Do Not Edit These Files Manually

Files in this directory are **automatically regenerated** on every build. Any manual changes will be overwritten.

## What's Here?

### `critical-css/`

Contains auto-generated critical CSS orchestration:

- `_generated-critical.scss` â€” All design tokens (abstracts) + components marked with `/* @critical */`
- `_generated-non-critical.scss` â€” All components NOT marked as critical

These files are imported by:

- `app/styles/index.scss` (critical CSS, inlined in `<head>`)
- `app/styles/non-critical-entry.scss` (non-critical CSS, lazy-loaded)

## For Developers

### Adding Design Tokens

1. Create new abstract file: `app/styles/abstracts/_yourToken.scss`
2. Export in: `app/styles/abstracts/index.scss`
3. **That's it!** The build system automatically imports it.

### Marking Components as Critical

1. Create component file: `app/components/my-comp/my-comp.scss`
2. Add `/* @critical */` to the first line if it's above-the-fold
3. **That's it!** The build system automatically imports it.

### How It Works

The `critical-css-scanner` Vite plugin:

1. Scans `app/styles/abstracts/` â†’ Finds all design tokens
2. Scans `app/components/` â†’ Finds files with `/* @critical */` markers
3. Auto-generates the files in this directory
4. Never needs manual intervention

## Questions?

See `DOCUMENTATION.md` for more information about the CSS token system and component organization.
```

---

### New: Generated File Structure

These files are created by the plugin during build (should not be committed):

#### `app/.internal/critical-css/_generated-critical.scss`

```scss
// AUTO-GENERATED - Do not edit manually
// Generated at: [timestamp]
// This file is regenerated on every yarn dev / yarn build

// ===================================
// ABSTRACTS (Auto-detected)
// ===================================
@use "../../styles/abstracts/borders";
@use "../../styles/abstracts/colors";
@use "../../styles/abstracts/dimensions";
@use "../../styles/abstracts/flex";
@use "../../styles/abstracts/functions";
@use "../../styles/abstracts/mixins";
@use "../../styles/abstracts/sizes";
@use "../../styles/abstracts/spacings";
@use "../../styles/abstracts/statuses";
@use "../../styles/abstracts/typography";
@use "../../styles/abstracts/breakpoints";

// ===================================
// CRITICAL COMPONENTS (/* @critical */)
// ===================================
@use "../../components/layout/header/header";
```

#### `app/.internal/critical-css/_generated-non-critical.scss`

```scss
// AUTO-GENERATED - Do not edit manually
// Generated at: [timestamp]
// This file is regenerated on every yarn dev / yarn build

// ===================================
// NON-CRITICAL COMPONENTS (unmarked)
// ===================================
@use "../../components/layout/footer/footer";
@use "../../components/post/search/search";
```

---

## 4. .gitignore Changes

### Add to `.gitignore`:

```
# Phase 4: Auto-managed critical CSS (auto-generated during build)
app/.internal/
```

### Remove from `.gitignore` (if they exist):

```
# Old patterns - no longer needed
# app/styles/create/_critical.scss
# app/styles/create/_non-critical.scss
```

**Note**: If these patterns don't exist in current .gitignore, no action needed.

---

## 5. Plugin Changes: `vite-plugins/critical-css-scanner.ts`

### Key Changes Summary

| Aspect                 | Phase 3               | Phase 4                       |
| ---------------------- | --------------------- | ----------------------------- |
| **Output directory**   | `app/styles/create/`  | `app/.internal/critical-css/` |
| **File names**         | `_critical.scss`      | `_generated-critical.scss`    |
| **Template files**     | Read templates, merge | 100% auto-generate            |
| **Abstract handling**  | Hardcoded in template | Auto-scan from `abstracts/`   |
| **Component handling** | Scan for markers      | Same (unchanged)              |
| **File generation**    | Template-based        | Direct code generation        |

### Detailed Changes (Reference for Implementation)

**Remove these functions:**

- `readTemplate()` â€” No longer needed
- `generateFromTemplate()` â€” Replaced with direct generation

**Add these functions:**

- `scanAbstracts(abstractsDir: string): Promise<string[]>`
  - Scan `app/styles/abstracts/` directory
  - Return array of filenames without `.scss` extension
  - Skip `index.scss`
  - Ignore `_breakpoints.scss` (not needed in critical)
  - Return: `['borders', 'colors', 'flex', ...]`

- `generateAbstractImports(abstracts: string[]): string`
  - Create @use statements for all abstracts
  - Format: `@use "../../styles/abstracts/colors";\n`
  - Include section header comment

- `generateComponentImports(files: GeneratedFiles): string`
  - Create @use statements for critical + non-critical components
  - Separate sections with comments
  - Format: `@use "../../components/layout/header/header";\n`

**Update existing functions:**

- `regenerateImports()` â€” Call new functions instead of template logic
- `scanDirectory()` â€” Unchanged (same component detection)
- File watcher â€” Unchanged (same debounce and HMR logic)

**Update paths:**

- Old: `path.resolve(appRoot, "styles", "create")`
- New: `path.resolve(appRoot, ".internal", "critical-css")`

---

## 6. File Structure After Phase 4

### Before (Phase 3)

```
app/
â”œâ”€â”€ styles/
â”‚   â”œâ”€â”€ abstracts/           (11 files, all tokens)
â”‚   â”œâ”€â”€ create/              â† Developer sees this
â”‚   â”‚   â”œâ”€â”€ _critical.template.scss      (Needs editing)
â”‚   â”‚   â”œâ”€â”€ _non-critical.template.scss  (Needs editing)
â”‚   â”‚   â”œâ”€â”€ _critical.scss       (gitignored but visible)
â”‚   â”‚   â”œâ”€â”€ _non-critical.scss   (gitignored but visible)
â”‚   â”‚   â”œâ”€â”€ _borders.scss
â”‚   â”‚   â”œâ”€â”€ _colors.scss
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ index.scss
â”‚   â””â”€â”€ non-critical-entry.scss
â””â”€â”€ components/              (Developer creates components here)
```

### After (Phase 4)

```
app/
â”œâ”€â”€ .internal/               â† HIDDEN (do not edit)
â”‚   â””â”€â”€ critical-css/
â”‚       â”œâ”€â”€ _generated-critical.scss       (auto-generated)
â”‚       â”œâ”€â”€ _generated-non-critical.scss   (auto-generated)
â”‚       â””â”€â”€ README.md        (warning label)
â”œâ”€â”€ styles/
â”‚   â”œâ”€â”€ abstracts/           (Developer adds tokens here)
â”‚   â”œâ”€â”€ create/              â† ONLY utility generators
â”‚   â”‚   â”œâ”€â”€ _borders.scss
â”‚   â”‚   â”œâ”€â”€ _colors.scss
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ index.scss           (import from .internal/)
â”‚   â””â”€â”€ non-critical-entry.scss (import from .internal/)
â””â”€â”€ components/              (Developer creates components here)
```

---

## Summary: Files to Change

| Action    | File                                            | Change Type                               |
| --------- | ----------------------------------------------- | ----------------------------------------- |
| âŒ Delete | `app/styles/create/_critical.template.scss`     | Remove file                               |
| âŒ Delete | `app/styles/create/_non-critical.template.scss` | Remove file                               |
| ğŸ“ Modify | `app/styles/create/_index.scss`                 | Remove abstract imports, keep utils       |
| ğŸ“ Modify | `app/styles/index.scss`                         | Import from `.internal/`, remove forwards |
| ğŸ“ Modify | `app/styles/non-critical-entry.scss`            | Import from `.internal/`, add utils       |
| ğŸ”§ Modify | `vite-plugins/critical-css-scanner.ts`          | Major refactor                            |
| âœ¨ New    | `app/.internal/critical-css/`                   | Create directory                          |
| âœ¨ New    | `app/.internal/README.md`                       | Create warning file                       |
| ğŸ“ Modify | `.gitignore`                                    | Add `app/.internal/` pattern              |

---

## Implementation Order

1. **Phase 4.0**: Create `.internal/` directory structure
2. **Phase 4.1**: Refactor plugin (hardest part)
3. **Phase 4.2**: Update SCSS entry points
4. **Phase 4.3-4.5**: Cleanup and verification
5. **Phase 4.6-4.7**: Testing
6. **Phase 4.8**: Documentation

---

## Testing Command Reference

### Dev Mode

```bash
rm -rf app/.internal/ build/ node_modules/.vite/
yarn dev
# Expected: Plugin scans abstracts and components, creates files in app/.internal/
```

### Build Mode

```bash
yarn build
# Expected: Two CSS files, no errors
```

### Production Server

```bash
yarn start
# Expected: Styles render correctly, no CSS duplication
```

---

This reference document is complete. Use it alongside `PHASE_4_AUTO_ABSTRACTS_PLAN.md` for full context.
